<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        /* Estilos para el nuevo control de búsqueda de coordenadas */
        .leaflet-control-coords {
            background: #fff;
            padding: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            border-radius: 5px;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .leaflet-control-coords input[type="text"] {
            width: 180px;
            padding: 4px;
            margin: 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .leaflet-control-coords button {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .leaflet-control-coords button:hover {
            background-color: #0056b3;
        }

        </style>
        <title></title>
    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/ActividadesGrupo_2.js"></script>
        <script>
        var highlightLayer;

        function highlightFeature(e) {
            highlightLayer = e.target;

            e.target._originalStyle = e.target.options.fillColor ? {
                radius: e.target.options.radius,
                opacity: e.target.options.opacity,
                color: e.target.options.color,
                dashArray: e.target.options.dashArray,
                lineCap: e.target.options.lineCap,
                lineJoin: e.target.options.lineJoin,
                weight: e.target.options.weight,
                fill: e.target.options.fill,
                fillOpacity: e.target.options.fillOpacity,
                fillColor: e.target.options.fillColor,
                interactive: e.target.options.interactive
            } : null;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: 'cyan',
                weight: 5
              });
            } else {
              highlightLayer.setStyle({
                color: 'cyan',
                weight: 4,
                opacity: 1,
                fillOpacity: e.target.options.fillOpacity
              });
            }

            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                highlightLayer.bringToFront();
            }
        }

        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[-44.47403719339656,-78.56977911648155],[-36.20821317609506,-62.44080111648155]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        function removeEmptyRowsFromPopupContent(content, feature) {
           var tempDiv = document.createElement('div');
           tempDiv.innerHTML = content;
           var rows = tempDiv.querySelectorAll('tr');
           for (var i = 0; i < rows.length; i++) {
               var td = rows[i].querySelector('td.visible-with-data');
               var key = td ? td.id : '';
               if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                   rows[i].parentNode.removeChild(rows[i]);
               }
           }
           return tempDiv.innerHTML;
        }

		function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');
			}
		}
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;

        map.createPane('pane_EsriSatellite_1');
        map.getPane('pane_EsriSatellite_1').style.zIndex = 401;
        var layer_EsriSatellite_1 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            pane: 'pane_EsriSatellite_1',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 17
        });
        layer_EsriSatellite_1;

        function pop_ActividadesGrupo_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    if (e.target._isSearchHighlighted) {
                        return;
                    }
                    if (e.target._originalStyle) {
                        e.target.setStyle(e.target._originalStyle);
                    } else {
                        e.target.setStyle(getOriginalStyle(e.target.feature));
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Categorias:</th>\
                        <td>' + (feature.properties['Categorias'] !== null ? autolinker.link(String(feature.properties['Categorias']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Descripción:</th>\
                        <td>' + (feature.properties['Descrip_'] !== null ? autolinker.link(String(feature.properties['Descrip_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Academicos:</th>\
                        <td>' + (feature.properties['Academicos'] !== null ? autolinker.link(String(feature.properties['Academicos']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        // --- Función para obtener el estilo original de una característica (punto) ---
        // Se mantiene para el comportamiento de hover y reset
        function getOriginalStyle(feature) {
            switch(String(feature.properties['Categorias'])) {
                case 'Apoyo Iniciativas de Conservación':
                    return {
                pane: 'pane_ActividadesGrupo_2',
                radius: 8.0,
                opacity: 1,
                color: 'rgba(50,87,128,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(72,123,182,1.0)',
                interactive: true,
            }
                    break;
                case 'Apoyo iniciativas privadas':
                    return {
                pane: 'pane_ActividadesGrupo_2',
                radius: 8.0,
                opacity: 1,
                color: 'rgba(50,87,128,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(18,236,252,1.0)',
                interactive: true,
            }
                    break;
                case 'Iniciativas de Educación y difusión':
                    return {
                pane: 'pane_ActividadesGrupo_2',
                radius: 8.0,
                opacity: 1,
                color: 'rgba(50,87,128,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(251,255,1,1.0)',
                interactive: true,
            }
                    break;
                case 'Monitoreo o muestreo de la especie':
                    return {
                pane: 'pane_ActividadesGrupo_2',
                radius: 8.0,
                opacity: 1,
                color: 'rgba(50,87,128,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(9,255,1,1.0)',
                interactive: true,
            }
                    break;
                case 'Reducción o mitigación de amenazas':
                    return {
                pane: 'pane_ActividadesGrupo_2',
                radius: 8.0,
                opacity: 1,
                color: 'rgba(128,17,25,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(219,30,42,1.0)',
                interactive: true,
            }
                    break;
                case 'Relevamiento de informacion sobre relacion guigna-humanos':
                    return {
                pane: 'pane_ActividadesGrupo_2',
                radius: 8.0,
                opacity: 1,
                color: 'rgba(83,83,83,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(247,247,247,1.0)',
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_ActividadesGrupo_2');
        map.getPane('pane_ActividadesGrupo_2').style.zIndex = 402;
        map.getPane('pane_ActividadesGrupo_2').style['mix-blend-mode'] = 'normal';

        // --- MODIFICACIÓN CLAVE: Crear capas individuales por categoría ---
        // Creamos un objeto para almacenar las capas de cada categoría
        var categoryLayers = {};
        var categories = [
            'Apoyo Iniciativas de Conservación',
            'Apoyo iniciativas privadas',
            'Iniciativas de Educación y difusión',
            'Monitoreo o muestreo de la especie',
            'Reducción o mitigación de amenazas',
            'Relevamiento de informacion sobre relacion guigna-humanos'
        ];

        // Iterar sobre los datos GeoJSON para crear una capa para cada categoría
        categories.forEach(function(category) {
            var featuresInCategory = json_ActividadesGrupo_2.features.filter(function(feature) {
                return feature.properties.Categorias === category;
            });

            if (featuresInCategory.length > 0) {
                var geoJsonData = {
                    "type": "FeatureCollection",
                    "name": category,
                    "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                    "features": featuresInCategory
                };

                var layer = L.geoJson(geoJsonData, {
                    attribution: '',
                    interactive: true,
                    dataVar: 'json_ActividadesGrupo_2', // Esto puede ser genérico o específico
                    layerName: 'layer_ActividadesGrupo_2_' + category.replace(/\s/g, '_'),
                    pane: 'pane_ActividadesGrupo_2',
                    onEachFeature: pop_ActividadesGrupo_2,
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, getOriginalStyle(feature));
                    },
                });
                categoryLayers[category] = layer; // Almacena la capa en el objeto
                bounds_group.addLayer(layer); // Añade cada subcapa al bounds_group
                // No añadimos la capa al mapa aquí, se hará a través del control de capas
            }
        });

        // Asegurarse de que layer_ActividadesGrupo_2 no se defina como una única capa si ya la estamos dividiendo.
        // Si json_ActividadesGrupo_2 ya está cargado por el script, se asume que contiene todos los puntos.
        // La variable global `layer_ActividadesGrupo_2` ahora deberá ser una referencia a la colección total
        // o ser modificada para referirse a todas las capas juntas para la búsqueda, o se debe ajustar la búsqueda.
        // Para la búsqueda, necesitamos una referencia a todas las capas combinadas, no una única capa GeoJSON.
        // Vamos a mantener la referencia original de la capa completa para el buscador,
        // pero la leyenda usará las capas individuales.

        // Una forma de manejar la búsqueda: crear una FeatureGroup con todas las subcapas
        var allActivityLayers = L.featureGroup(Object.values(categoryLayers));
        map.addLayer(allActivityLayers); // Asegúrate de que todos los puntos estén en el mapa, aunque sea invisible al inicio

        var baseLayers = [
            {label: "OpenStreetMap", layer: layer_OpenStreetMap_0},
            {label: "Esri Satellite", layer: layer_EsriSatellite_1}
        ];

        var overlays = [
            {
                label: 'Actividades Grupo',
                children: [
                    {label: 'Apoyo Iniciativas de Conservación<br /><img src="legend/ActividadesGrupo_2_ApoyoIniciativasdeConservación0.png" />', layer: categoryLayers['Apoyo Iniciativas de Conservación']},
                    {label: 'Apoyo iniciativas privadas<br /><img src="legend/ActividadesGrupo_2_Apoyoiniciativasprivadas1.png" />', layer: categoryLayers['Apoyo iniciativas privadas']},
                    {label: 'Iniciativas de Educación y difusión<br /><img src="legend/ActividadesGrupo_2_IniciativasdeEducaciónydifusión2.png" />', layer: categoryLayers['Iniciativas de Educación y difusión']},
                    {label: 'Monitoreo o muestreo de la especie<br /><img src="legend/ActividadesGrupo_2_Monitoreoomuestreodelaespecie3.png" />', layer: categoryLayers['Monitoreo o muestreo de la especie']},
                    {label: 'Reducción o mitigación de amenazas<br /><img src="legend/ActividadesGrupo_2_Reducciónomitigacióndeamenazas4.png" />', layer: categoryLayers['Reducción o mitigación de amenazas']},
                    {label: 'Relevamiento de informacion sobre relacion guigna-humanos<br /><img src="legend/ActividadesGrupo_2_Relevamientodeinformacionsobrerelacionguignahumanos5.png" />', layer: categoryLayers['Relevamiento de informacion sobre relacion guigna-humanos']}
                ]
            }
        ];

        layer_EsriSatellite_1.addTo(map);

        var lay = L.control.layers.tree(baseLayers, overlays, {
            collapsed: false,
        });
        lay.addTo(map);
        setBounds();

        // --- INICIO DE LA MODIFICACIÓN EN L.Control.Search ---
        // Ahora el buscador debe operar sobre todasActivityLayers
        var searchControl = new L.Control.Search({
            layer: allActivityLayers, // Usa la FeatureGroup que contiene todas las subcapas
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'Categorias',
            zoom: 14,
            marker: false,
        });

        map.addControl(searchControl);

        searchControl.on('search:located', function(e) {
            // Recorre TODAS las capas en allActivityLayers para resetear y luego aplicar el resaltado
            allActivityLayers.eachLayer(function(layer) {
                // Asegúrate de que cada capa tenga la función setStyle
                if (layer.setStyle) {
                    layer.setStyle(getOriginalStyle(layer.feature));
                }
                if (layer.getPopup() && layer.getPopup().isOpen()) {
                    layer.closePopup();
                }
                layer._isSearchHighlighted = false;
            });

            var bounds = L.latLngBounds([]);
            var matchingLayers = [];

            allActivityLayers.eachLayer(function(layer) {
                if (layer.feature.properties.Categorias === e.text) {
                    layer.setStyle({
                        radius: 12.0,
                        color: 'yellow',
                        weight: 4.0,
                        fillColor: 'yellow',
                        fillOpacity: 0.7
                    });
                    if (layer.bringToFront) {
                        layer.bringToFront();
                    }
                    if (layer.openPopup) {
                        layer.openPopup();
                    }
                    bounds.extend(layer.getLatLng());
                    matchingLayers.push(layer);
                    layer._isSearchHighlighted = true;
                }
            });

            if (!bounds.isEmpty() && matchingLayers.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            } else if (matchingLayers.length === 1) {
                map.setView(matchingLayers[0].getLatLng(), searchControl.options.zoom);
            }
        });

        searchControl.on('search:collapsed', function() {
            allActivityLayers.eachLayer(function(layer) {
                if (layer.setStyle) {
                    layer.setStyle(getOriginalStyle(layer.feature));
                }
                if (layer.getPopup() && layer.getPopup().isOpen()) {
                    layer.closePopup();
                }
                layer._isSearchHighlighted = false;
            });
        });

        if (typeof url === 'undefined') {
            document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';
        } else {
            document.getElementsByClassName('search-button')[1].className += ' fa fa-binoculars';
        }

        map.invalidateSize();

        // --- INICIO DE LA NUEVA FUNCIONALIDAD DE BÚSQUEDA POR COORDENADAS (Modificada) ---
        var currentCoordMarker;

        var CoordsSearchControl = L.Control.extend({
            onAdd: function(map) {
                var div = L.DomUtil.create('div', 'leaflet-control-coords');
                div.innerHTML = 'Coordenadas (Lat Lon): <input type="text" id="coordInput" value="-39.247217 -72.204498" /> ' +
                                '<button id="goCoords">Ir</button>';

                L.DomEvent.disableClickPropagation(div);

                var goButton = div.querySelector('#goCoords');
                L.DomEvent.on(goButton, 'click', function() {
                    var inputString = div.querySelector('#coordInput').value;
                    var parts = inputString.trim().split(/\s+/);

                    if (parts.length === 2) {
                        var lat = parseFloat(parts[0]);
                        var lon = parseFloat(parts[1]);

                        if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                            map.setView([lat, lon], 14);

                            if (currentCoordMarker) {
                                map.removeLayer(currentCoordMarker);
                            }

                            currentCoordMarker = L.marker([lat, lon]).addTo(map)
                                .bindPopup(`**Coordenadas:**<br>Lat: ${lat}<br>Lon: ${lon}`)
                                .openPopup();

                            currentCoordMarker.on('popupclose', function() {
                                if (currentCoordMarker) {
                                    map.removeLayer(currentCoordMarker);
                                    currentCoordMarker = null;
                                }
                            });

                        } else {
                            alert('Por favor, introduce coordenadas numéricas válidas (Lat: -90 a 90, Lon: -180 a 180).');
                        }
                    } else {
                        alert('Formato incorrecto. Por favor, introduce las coordenadas como "Latitud Longitud" (ej: -39.247217 -72.204498).');
                    }
                });

                var coordInput = div.querySelector('#coordInput');
                L.DomEvent.on(coordInput, 'keydown', function(e) {
                    if (e.keyCode === 13) {
                        goButton.click();
                    }
                });

                return div;
            },
            onRemove: function(map) {
                // Limpia el control si es necesario
            }
        });

        new CoordsSearchControl().addTo(map);
        // --- FIN DE LA NUEVA FUNCIONALIDAD DE BÚSQUEDA POR COORDENADAS (Modificada) ---
        </script>
    </body>
</html>
